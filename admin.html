<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Survey Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .header {
      background: #1e88e5;
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1e88e5;
      margin-bottom: 0.5rem;
    }
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .chart-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .chart-container canvas {
      max-height: 300px !important;
      height: 300px !important;
    }
    .data-table {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .table-header {
      background: #f8f9fa;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #dee2e6;
    }
    .table-content {
      max-height: 400px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #f1f3f4;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    .error {
      background: #fee;
      color: #c33;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .export-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üè∫ Terracotta Dreams - Analytics Dashboard</h1>
  </div>

  <div class="container">
    <div id="loading" class="loading">
      Caricamento dati...
    </div>

    <div id="error" class="error" style="display: none;">
      Errore nel caricamento dei dati
    </div>

    <div id="dashboard" style="display: none;">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-responses">0</div>
          <div class="stat-label">Risposte Totali</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="last-update">-</div>
          <div class="stat-label">Ultimo Aggiornamento</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completion-rate">-</div>
          <div class="stat-label">Tasso Completamento</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avg-checkout-time">-</div>
          <div class="stat-label">Tempo Medio Checkout</div>
        </div>
      </div>

      <!-- Charts -->
      
      <!-- Demografia Base -->
      <h2 style="margin: 2rem 0 1rem 0; color: #333;">üìä Demografia Base</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Distribuzione Et√†</div>
          <div class="chart-container">
            <canvas id="ageChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Distribuzione Genere</div>
          <div class="chart-container">
            <canvas id="genderChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Educazione</div>
          <div class="chart-container">
            <canvas id="educationChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Dispositivo</div>
          <div class="chart-container">
            <canvas id="deviceChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Situazione Finanziaria</div>
          <div class="chart-container">
            <canvas id="financialChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Frequenza Acquisti</div>
          <div class="chart-container">
            <canvas id="frequencyChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Ecommerce Data -->
      <h2 style="margin: 2rem 0 1rem 0; color: #333;">üõí Dati Ecommerce</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Prodotti Scelti</div>
          <div class="chart-container">
            <canvas id="productChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Metodi di Spedizione</div>
          <div class="chart-container">
            <canvas id="deliveryChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Varianti Checkout</div>
          <div class="chart-container">
            <canvas id="checkoutVariantChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Tempo nel Checkout</div>
          <div class="chart-container">
            <canvas id="checkoutTimeChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Survey Iniziale - Likert -->
      <h2 style="margin: 2rem 0 1rem 0; color: #333;">üìã Survey Iniziale (Scale Likert 1-7)</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Stress Finanziario</div>
          <div class="chart-container">
            <canvas id="stressFinancialChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Aprire File Scaricati</div>
          <div class="chart-container">
            <canvas id="downloadFilesChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Aprire Nuove Tab</div>
          <div class="chart-container">
            <canvas id="openTabsChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Ritrovare Siti</div>
          <div class="chart-container">
            <canvas id="findWebsiteChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Stancarsi Online</div>
          <div class="chart-container">
            <canvas id="getTiredChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Finire su Siti Sbagliati</div>
          <div class="chart-container">
            <canvas id="endUpSitesChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Struttura Confusa</div>
          <div class="chart-container">
            <canvas id="confusingStructureChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Shopping Facile</div>
          <div class="chart-container">
            <canvas id="easyShoppingChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Prodotti Non Disponibili</div>
          <div class="chart-container">
            <canvas id="buyUnavailableChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Risparmiare Tempo</div>
          <div class="chart-container">
            <canvas id="saveTimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Confrontare Prodotti</div>
          <div class="chart-container">
            <canvas id="easyCompareChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Evitare Fastidi</div>
          <div class="chart-container">
            <canvas id="avoidHassleChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Divertirsi Shopping</div>
          <div class="chart-container">
            <canvas id="enjoyShoppingChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Survey Finale -->
      <h2 style="margin: 2rem 0 1rem 0; color: #333;">üå± Survey Finale</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Considerazione Ambientale</div>
          <div class="chart-container">
            <canvas id="environmentalChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Sentirsi Irresponsabili</div>
          <div class="chart-container">
            <canvas id="feelIrresponsibleChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Sentirsi in Colpa</div>
          <div class="chart-container">
            <canvas id="feelGuiltyChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Sentirsi Responsabili</div>
          <div class="chart-container">
            <canvas id="feelResponsibleChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Overview Difficile</div>
          <div class="chart-container">
            <canvas id="difficultOverviewChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Design Difficile</div>
          <div class="chart-container">
            <canvas id="difficultDesignChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Sforzo per Capire</div>
          <div class="chart-container">
            <canvas id="effortUnderstandChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Opzioni Difficili</div>
          <div class="chart-container">
            <canvas id="difficultOptionsChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Descrizioni Utili</div>
          <div class="chart-container">
            <canvas id="usefulDescriptionsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="data-table">
        <div class="table-header">
          <button class="export-btn" onclick="exportData()">üì• Esporta CSV</button>
          <h3 style="margin: 0; display: inline-block; margin-left: 1rem;">Dati Dettagliati</h3>
        </div>
        <div class="table-content">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Data</th>
                <th>Session ID</th>
                <th>Et√†</th>
                <th>Genere</th>
                <th>Prodotto</th>
                <th>Spedizione</th>
                <th>Tempo Checkout</th>
                <th>Tempo Totale</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let surveyData = [];
    // Oggetto per contenere tutti i grafici
    let charts = {};

    async function loadData() {
      try {
        const response = await fetch('/api/get-data');
        const result = await response.json();

        if (result.success) {
          surveyData = result.data;
          updateStats(result.stats);
          createCharts(result.stats);
          populateTable(result.data);
          
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Errore:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    function updateStats(stats) {
      document.getElementById('total-responses').textContent = stats.totalResponses;
      document.getElementById('last-update').textContent = 
        stats.lastUpdate ? new Date(stats.lastUpdate).toLocaleDateString('it-IT') : 'Mai';
      document.getElementById('completion-rate').textContent = '100%'; // Placeholder
      document.getElementById('avg-checkout-time').textContent = stats.averageCheckoutTime || '-';
    }

    function createCharts(stats) {
      // Distruggi tutti i grafici esistenti
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      charts = {};

      // Age Chart
      const ageCtx = document.getElementById('ageChart').getContext('2d');
      ageChart = new Chart(ageCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(stats.ageDistribution),
          datasets: [{
            data: Object.values(stats.ageDistribution),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Gender Chart
      const genderCtx = document.getElementById('genderChart').getContext('2d');
      genderChart = new Chart(genderCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(stats.genderDistribution),
          datasets: [{
            label: 'Risposte',
            data: Object.values(stats.genderDistribution),
            backgroundColor: '#36A2EB'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Product Chart
      const productCtx = document.getElementById('productChart').getContext('2d');
      productChart = new Chart(productCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(stats.productDistribution),
          datasets: [{
            data: Object.values(stats.productDistribution),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Delivery Chart
      const deliveryCtx = document.getElementById('deliveryChart').getContext('2d');
      deliveryChart = new Chart(deliveryCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(stats.deliveryDistribution),
          datasets: [{
            label: 'Scelte',
            data: Object.values(stats.deliveryDistribution),
            backgroundColor: '#4BC0C0'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Checkout Time Chart
      const checkoutTimeCtx = document.getElementById('checkoutTimeChart').getContext('2d');
      checkoutTimeChart = new Chart(checkoutTimeCtx, {
        type: 'bar',
        data: {
          labels: stats.checkoutTimeRanges.labels,
          datasets: [{
            label: 'Numero utenti',
            data: stats.checkoutTimeRanges.data,
            backgroundColor: '#9966FF'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Checkout Variant Chart
      const checkoutVariantCtx = document.getElementById('checkoutVariantChart').getContext('2d');
      checkoutVariantChart = new Chart(checkoutVariantCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(stats.checkoutVariantDistribution),
          datasets: [{
            data: Object.values(stats.checkoutVariantDistribution),
            backgroundColor: ['#FF9F40', '#FF6384', '#36A2EB', '#FFCE56']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function populateTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      data.forEach((item, index) => {
        const row = tbody.insertRow();
        
        // Calcola tempo totale in formato leggibile
        const timeSpent = item.totalTimeSpent ? 
          Math.round(item.totalTimeSpent / 60000) + ' min' : 'N/A';
        
        // Calcola tempo checkout
        const checkoutTime = item.orderData?.checkoutTimeSpent ? 
          Math.round(item.orderData.checkoutTimeSpent / 1000) + 's' : 'N/A';
        
        row.innerHTML = `
          <td>${new Date(item.timestamp).toLocaleDateString('it-IT')} ${new Date(item.timestamp).toLocaleTimeString('it-IT')}</td>
          <td>${item.sessionId || 'N/A'}</td>
          <td>${item.initialSurvey?.age || 'N/A'}</td>
          <td>${item.initialSurvey?.gender || 'N/A'}</td>
          <td>${item.orderData?.productTitle || 'N/A'}</td>
          <td>${item.orderData?.deliveryValue === 'home' ? 'üè† Casa' : item.orderData?.deliveryValue === 'cc' ? 'üì¶ C&C' : 'N/A'}</td>
          <td>${checkoutTime}</td>
          <td>${timeSpent}</td>
          <td>
            <button onclick="viewDetails(${index})" style="background:#007bff;color:white;border:none;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;">
              Dettagli
            </button>
          </td>
        `;
      });
    }

    function viewDetails(index) {
      const item = surveyData[index];
      
      // Crea una finestra popup con TUTTI i dettagli formattati
      const details = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä DETTAGLI COMPLETI RISPOSTA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üÜî IDENTIFICATORI:
‚Ä¢ Session ID: ${item.sessionId || 'N/A'}
‚Ä¢ Timestamp: ${item.timestamp || 'N/A'}
‚Ä¢ Data locale: ${new Date(item.timestamp).toLocaleString('it-IT')}
‚Ä¢ Completato il: ${item.completedAt || 'N/A'}

‚è±Ô∏è ANALISI TEMPORALE:
‚Ä¢ Tempo totale (ms): ${item.totalTimeSpent || 'N/A'}
‚Ä¢ Tempo totale (minuti): ${item.totalTimeSpent ? Math.round(item.totalTimeSpent / 60000) + ' min' : 'N/A'}
‚Ä¢ Survey iniziale completato: ${item.initialSurveyCompletedAt || 'N/A'}
‚Ä¢ Ecommerce iniziato: ${item.ecommerceStartedAt || 'N/A'}
‚Ä¢ Survey finale completato: ${item.finalSurveyCompletedAt || 'N/A'}
‚Ä¢ Tempo nel checkout: ${item.orderData?.checkoutTimeSpent ? Math.round(item.orderData.checkoutTimeSpent / 1000) + ' secondi (' + item.orderData.checkoutTimeSpent + ' ms)' : 'N/A'}

üìã SURVEY INIZIALE COMPLETO:
‚Ä¢ Et√†: ${item.initialSurvey?.age || 'N/A'}
‚Ä¢ Genere: ${item.initialSurvey?.gender || 'N/A'}
‚Ä¢ Educazione: ${item.initialSurvey?.education || 'N/A'}
‚Ä¢ Dispositivo: ${item.initialSurvey?.device || 'N/A'}
‚Ä¢ Situazione finanziaria: ${item.initialSurvey?.financial || 'N/A'}
‚Ä¢ Frequenza acquisti: ${item.initialSurvey?.frequency || 'N/A'}
‚Ä¢ Si stanca facilmente: ${item.initialSurvey?.get_tired !== undefined ? item.initialSurvey.get_tired : 'N/A'}
‚Ä¢ Apre troppe tabs: ${item.initialSurvey?.open_tabs !== undefined ? item.initialSurvey.open_tabs : 'N/A'}
‚Ä¢ Vuole risparmiare tempo: ${item.initialSurvey?.save_time !== undefined ? item.initialSurvey.save_time : 'N/A'}
‚Ä¢ Evita difficolt√†: ${item.initialSurvey?.avoid_hassle !== undefined ? item.initialSurvey.avoid_hassle : 'N/A'}
‚Ä¢ Facilit√† confronto: ${item.initialSurvey?.easy_compare !== undefined ? item.initialSurvey.easy_compare : 'N/A'}
‚Ä¢ Finisce su altri siti: ${item.initialSurvey?.end_up_sites !== undefined ? item.initialSurvey.end_up_sites : 'N/A'}
‚Ä¢ Facilit√† trovare siti: ${item.initialSurvey?.find_website !== undefined ? item.initialSurvey.find_website : 'N/A'}
‚Ä¢ Shopping facile: ${item.initialSurvey?.easy_shopping !== undefined ? item.initialSurvey.easy_shopping : 'N/A'}
‚Ä¢ Scarica file: ${item.initialSurvey?.download_files !== undefined ? item.initialSurvey.download_files : 'N/A'}
‚Ä¢ Si diverte a fare shopping: ${item.initialSurvey?.enjoy_shopping !== undefined ? item.initialSurvey.enjoy_shopping : 'N/A'}
‚Ä¢ Compra prodotti non disponibili: ${item.initialSurvey?.buy_unavailable !== undefined ? item.initialSurvey.buy_unavailable : 'N/A'}
‚Ä¢ Stress finanziario: ${item.initialSurvey?.stress_financial !== undefined ? item.initialSurvey.stress_financial : 'N/A'}
‚Ä¢ Struttura confusa: ${item.initialSurvey?.confusing_structure !== undefined ? item.initialSurvey.confusing_structure : 'N/A'}

üõí DATI ECOMMERCE COMPLETI:
‚Ä¢ Prodotto scelto: ${item.orderData?.productTitle || 'N/A'}
‚Ä¢ ID Prodotto: ${item.orderData?.productId || 'N/A'}
‚Ä¢ Prezzo prodotto: ${item.orderData?.productPrice || 'N/A'}
‚Ä¢ Nome: ${item.orderData?.firstName || 'N/A'}
‚Ä¢ Cognome: ${item.orderData?.lastName || 'N/A'}
‚Ä¢ Indirizzo spedizione: ${item.orderData?.shippingAddress || 'N/A'}
‚Ä¢ Metodo consegna: ${item.orderData?.deliveryMethod || 'N/A'}
‚Ä¢ Valore delivery: ${item.orderData?.deliveryValue || 'N/A'}
‚Ä¢ Ordine completato: ${item.orderData?.orderCompletedAt || 'N/A'}

üéØ DATI CHECKOUT:
‚Ä¢ Variante checkout: ${item.checkoutData?.variant || 'N/A'}
‚Ä¢ Prodotto checkout: ${item.checkoutData?.product ? JSON.stringify(item.checkoutData.product, null, 2) : 'N/A'}
‚Ä¢ Checkout iniziato: ${item.checkoutData?.checkoutStartedAt || 'N/A'}
‚Ä¢ Click data: ${item.checkoutData?.productClickData ? JSON.stringify(item.checkoutData.productClickData, null, 2) : 'N/A'}

üì± INTERAZIONI PRODOTTI:
${item.productInteractions ? Object.entries(item.productInteractions).map(([productId, data]) => 
  `‚Ä¢ Prodotto ${productId}: ${data.clickCount} click, primo click: ${new Date(data.firstClickAt).toLocaleString('it-IT')}`
).join('\n') : '‚Ä¢ Nessuna interazione tracciata'}

üìù SURVEY FINALE COMPLETO:
‚Ä¢ Considerazione ambientale: ${item.finalSurvey?.environmental_consideration || 'N/A'}
‚Ä¢ Si sente colpevole: ${item.finalSurvey?.feel_guilty !== undefined ? item.finalSurvey.feel_guilty : 'N/A'}
‚Ä¢ Design difficile: ${item.finalSurvey?.difficult_design !== undefined ? item.finalSurvey.difficult_design : 'N/A'}
‚Ä¢ Si sente responsabile: ${item.finalSurvey?.feel_responsible !== undefined ? item.finalSurvey.feel_responsible : 'N/A'}
‚Ä¢ Opzioni difficili: ${item.finalSurvey?.difficult_options !== undefined ? item.finalSurvey.difficult_options : 'N/A'}
‚Ä¢ Sforzo per capire: ${item.finalSurvey?.effort_understand !== undefined ? item.finalSurvey.effort_understand : 'N/A'}
‚Ä¢ Overview difficile: ${item.finalSurvey?.difficult_overview !== undefined ? item.finalSurvey.difficult_overview : 'N/A'}
‚Ä¢ Si sente irresponsabile: ${item.finalSurvey?.feel_irresponsible !== undefined ? item.finalSurvey.feel_irresponsible : 'N/A'}
‚Ä¢ Descrizioni utili: ${item.finalSurvey?.useful_descriptions !== undefined ? item.finalSurvey.useful_descriptions : 'N/A'}

üîß DATI RAW (JSON):
${JSON.stringify(item, null, 2)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      `;
      
      alert(details);
    }

    function exportData() {
      if (surveyData.length === 0) {
        alert('Nessun dato da esportare');
        return;
      }

      const csv = convertToCSV(surveyData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `survey-data-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function convertToCSV(data) {
      const headers = [
        'Timestamp', 'SessionID', 'Age', 'Gender', 'Education', 'Device', 
        'Financial', 'Frequency', 'ProductTitle', 'ProductID', 'DeliveryMethod', 
        'DeliveryValue', 'CheckoutTimeSeconds', 'CheckoutVariant',
        'EnvironmentalConsideration', 'TotalTimeMinutes', 'ProductClicks'
      ];
      
      const rows = data.map(item => [
        item.timestamp || '',
        item.sessionId || '',
        item.initialSurvey?.age || '',
        item.initialSurvey?.gender || '',
        item.initialSurvey?.education || '',
        item.initialSurvey?.device || '',
        item.initialSurvey?.financial || '',
        item.initialSurvey?.frequency || '',
        item.orderData?.productTitle || '',
        item.orderData?.productId || '',
        item.orderData?.deliveryMethod || '',
        item.orderData?.deliveryValue || '',
        item.orderData?.checkoutTimeSpent ? Math.round(item.orderData.checkoutTimeSpent / 1000) : '',
        item.checkoutData?.variant || '',
        item.finalSurvey?.environmental_consideration || '',
        item.totalTimeSpent ? Math.round(item.totalTimeSpent / 60000) : '',
        item.productInteractions ? Object.values(item.productInteractions).reduce((sum, data) => sum + data.clickCount, 0) : ''
      ]);

      return [headers, ...rows].map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
    }

    // Carica dati all'avvio
    loadData();

    // Ricarica automaticamente ogni 30 secondi
    setInterval(loadData, 30000);
  </script>
</body>
</html> 