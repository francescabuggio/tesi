<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Survey Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .header {
      background: #1e88e5;
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1e88e5;
      margin-bottom: 0.5rem;
    }
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .chart-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .chart-container canvas {
      max-height: 300px !important;
      height: 300px !important;
    }
    .data-table {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .table-header {
      background: #f8f9fa;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #dee2e6;
    }
    .table-content {
      max-height: 400px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #f1f3f4;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    .error {
      background: #fee;
      color: #c33;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .export-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>📊 Dashboard Survey Results</h1>
  </div>

  <div class="container">
    <div id="loading" class="loading">
      Caricamento dati...
    </div>

    <div id="error" class="error" style="display: none;">
      Errore nel caricamento dei dati
    </div>

    <div id="dashboard" style="display: none;">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-responses">0</div>
          <div class="stat-label">Risposte Totali</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="last-update">-</div>
          <div class="stat-label">Ultimo Aggiornamento</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completion-rate">-</div>
          <div class="stat-label">Tasso Completamento</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Distribuzione Età</div>
          <div class="chart-container">
            <canvas id="ageChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Distribuzione Genere</div>
          <div class="chart-container">
            <canvas id="genderChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="data-table">
        <div class="table-header">
          <button class="export-btn" onclick="exportData()">📥 Esporta CSV</button>
          <h3 style="margin: 0; display: inline-block; margin-left: 1rem;">Dati Dettagliati</h3>
        </div>
        <div class="table-content">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Data</th>
                <th>Session ID</th>
                <th>Età</th>
                <th>Genere</th>
                <th>Educazione</th>
                <th>Dispositivo</th>
                <th>Tempo Totale</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let surveyData = [];
    let ageChart = null;
    let genderChart = null;

    async function loadData() {
      try {
        const response = await fetch('/api/get-data');
        const result = await response.json();

        if (result.success) {
          surveyData = result.data;
          updateStats(result.stats);
          createCharts(result.stats);
          populateTable(result.data);
          
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Errore:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    function updateStats(stats) {
      document.getElementById('total-responses').textContent = stats.totalResponses;
      document.getElementById('last-update').textContent = 
        stats.lastUpdate ? new Date(stats.lastUpdate).toLocaleDateString('it-IT') : 'Mai';
      document.getElementById('completion-rate').textContent = '100%'; // Placeholder
    }

    function createCharts(stats) {
      // Distruggi i grafici esistenti prima di crearne di nuovi
      if (ageChart) {
        ageChart.destroy();
      }
      if (genderChart) {
        genderChart.destroy();
      }

      // Age Chart
      const ageCtx = document.getElementById('ageChart').getContext('2d');
      ageChart = new Chart(ageCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(stats.ageDistribution),
          datasets: [{
            data: Object.values(stats.ageDistribution),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Gender Chart
      const genderCtx = document.getElementById('genderChart').getContext('2d');
      genderChart = new Chart(genderCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(stats.genderDistribution),
          datasets: [{
            label: 'Risposte',
            data: Object.values(stats.genderDistribution),
            backgroundColor: '#36A2EB'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function populateTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      data.forEach((item, index) => {
        const row = tbody.insertRow();
        
        // Calcola tempo totale in formato leggibile
        const timeSpent = item.totalTimeSpent ? 
          Math.round(item.totalTimeSpent / 60000) + ' min' : 'N/A';
        
        row.innerHTML = `
          <td>${new Date(item.timestamp).toLocaleDateString('it-IT')} ${new Date(item.timestamp).toLocaleTimeString('it-IT')}</td>
          <td>${item.sessionId || 'N/A'}</td>
          <td>${item.initialSurvey?.age || 'N/A'}</td>
          <td>${item.initialSurvey?.gender || 'N/A'}</td>
          <td>${item.initialSurvey?.education || 'N/A'}</td>
          <td>${item.initialSurvey?.device || 'N/A'}</td>
          <td>${timeSpent}</td>
          <td>
            <button onclick="viewDetails(${index})" style="background:#007bff;color:white;border:none;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;">
              Dettagli
            </button>
          </td>
        `;
      });
    }

    function viewDetails(index) {
      const item = surveyData[index];
      
      // Crea una finestra popup con i dettagli formattati
      const details = `
═══════════════════════════
📊 DETTAGLI RISPOSTA
═══════════════════════════

🆔 Session ID: ${item.sessionId || 'N/A'}
📅 Data: ${new Date(item.timestamp).toLocaleString('it-IT')}
⏱️ Tempo totale: ${item.totalTimeSpent ? Math.round(item.totalTimeSpent / 60000) + ' minuti' : 'N/A'}

📋 SURVEY INIZIALE:
• Età: ${item.initialSurvey?.age || 'N/A'}
• Genere: ${item.initialSurvey?.gender || 'N/A'}
• Educazione: ${item.initialSurvey?.education || 'N/A'}
• Dispositivo: ${item.initialSurvey?.device || 'N/A'}
• Situazione finanziaria: ${item.initialSurvey?.financial || 'N/A'}
• Frequenza acquisti: ${item.initialSurvey?.frequency || 'N/A'}

🛒 DATI ECOMMERCE:
• Prodotto scelto: ${item.orderData?.productTitle || 'N/A'}
• Metodo consegna: ${item.orderData?.deliveryMethod || 'N/A'}
• Variante checkout: ${item.checkoutData?.variant || 'N/A'}

📝 SURVEY FINALE:
• Considerazione ambientale: ${item.finalSurvey?.environmental_consideration || 'N/A'}
• Difficoltà overview: ${item.finalSurvey?.difficult_overview || 'N/A'}
• Descrizioni utili: ${item.finalSurvey?.useful_descriptions || 'N/A'}

═══════════════════════════
      `;
      
      alert(details);
    }

    function exportData() {
      if (surveyData.length === 0) {
        alert('Nessun dato da esportare');
        return;
      }

      const csv = convertToCSV(surveyData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `survey-data-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function convertToCSV(data) {
      const headers = [
        'Timestamp', 'SessionID', 'Age', 'Gender', 'Education', 'Device', 
        'Financial', 'Frequency', 'Product', 'DeliveryMethod', 'CheckoutVariant',
        'EnvironmentalConsideration', 'TotalTimeMinutes'
      ];
      
      const rows = data.map(item => [
        item.timestamp || '',
        item.sessionId || '',
        item.initialSurvey?.age || '',
        item.initialSurvey?.gender || '',
        item.initialSurvey?.education || '',
        item.initialSurvey?.device || '',
        item.initialSurvey?.financial || '',
        item.initialSurvey?.frequency || '',
        item.orderData?.productTitle || '',
        item.orderData?.deliveryMethod || '',
        item.checkoutData?.variant || '',
        item.finalSurvey?.environmental_consideration || '',
        item.totalTimeSpent ? Math.round(item.totalTimeSpent / 60000) : ''
      ]);

      return [headers, ...rows].map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
    }

    // Carica dati all'avvio
    loadData();

    // Ricarica automaticamente ogni 30 secondi
    setInterval(loadData, 30000);
  </script>
</body>
</html> 